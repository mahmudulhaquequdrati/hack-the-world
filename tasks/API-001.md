# API-001: Create Content API Endpoints (SERVER)

## ðŸ“‹ Task Overview

**Task ID**: API-001
**Title**: Create Content API Endpoints (SERVER)
**Priority**: ðŸŸ¡ High
**Status**: ðŸ“‹ Not Started
**Assignee**: Developer
**Due Date**: January 19, 2025
**Estimated Hours**: 3-4 hours

## ðŸŽ¯ Objective

Create comprehensive REST API endpoints for the unified Content model that handles all content types (videos, labs, games). This single API will replace the need for separate Video, Lab, Game, and Document APIs, simplifying both backend and frontend integration.

## ðŸ”Œ API Endpoints Overview

### Base URL: `/api/content`

| Method | Endpoint                        | Description                          | Auth Required |
| ------ | ------------------------------- | ------------------------------------ | ------------- |
| GET    | `/api/content`                  | Get all content with filtering       | âœ…            |
| GET    | `/api/content/:id`              | Get specific content by ID           | âœ…            |
| GET    | `/api/content/module/:moduleId` | Get all content for a module         | âœ…            |
| GET    | `/api/content/type/:type`       | Get content by type (video/lab/game) | âœ…            |
| POST   | `/api/content`                  | Create new content                   | âœ… Admin      |
| PUT    | `/api/content/:id`              | Update content                       | âœ… Admin      |
| DELETE | `/api/content/:id`              | Delete content                       | âœ… Admin      |

## ðŸ”§ Technical Implementation

### Content Controller

```javascript
// server/src/controllers/contentController.js
const Content = require("../models/Content");
const { asyncHandler } = require("../middleware/asyncHandler");
const { ErrorResponse } = require("../utils/errorResponse");

/**
 * @desc    Get all content with optional filtering
 * @route   GET /api/content
 * @access  Private
 * @query   ?type=video&moduleId=basic-cybersec&limit=10&page=1
 */
const getAllContent = asyncHandler(async (req, res) => {
  const { type, moduleId, limit = 10, page = 1 } = req.query;

  // Build query object
  let query = { isActive: true };
  if (type) query.type = type;
  if (moduleId) query.moduleId = moduleId;

  // Calculate pagination
  const skip = (page - 1) * limit;

  const content = await Content.find(query)
    .sort({ moduleId: 1, order: 1 })
    .limit(parseInt(limit))
    .skip(skip);

  const total = await Content.countDocuments(query);

  res.status(200).json({
    success: true,
    message: "Content retrieved successfully",
    data: content,
    pagination: {
      page: parseInt(page),
      limit: parseInt(limit),
      total,
      pages: Math.ceil(total / limit),
    },
  });
});

/**
 * @desc    Get content by ID
 * @route   GET /api/content/:id
 * @access  Private
 */
const getContentById = asyncHandler(async (req, res, next) => {
  const { id } = req.params;

  const content = await Content.findOne({ id, isActive: true });

  if (!content) {
    return next(new ErrorResponse("Content not found", 404));
  }

  res.status(200).json({
    success: true,
    message: "Content retrieved successfully",
    data: content,
  });
});

/**
 * @desc    Get content by module
 * @route   GET /api/content/module/:moduleId
 * @access  Private
 */
const getContentByModule = asyncHandler(async (req, res, next) => {
  const { moduleId } = req.params;

  const content = await Content.getByModule(moduleId);

  res.status(200).json({
    success: true,
    message: `Content for module ${moduleId} retrieved successfully`,
    data: content,
  });
});

/**
 * @desc    Get content by type
 * @route   GET /api/content/type/:type
 * @access  Private
 */
const getContentByType = asyncHandler(async (req, res, next) => {
  const { type } = req.params;
  const { moduleId } = req.query;

  // Validate content type
  if (!["video", "lab", "game"].includes(type)) {
    return next(new ErrorResponse("Invalid content type", 400));
  }

  const content = await Content.getByType(type, moduleId);

  res.status(200).json({
    success: true,
    message: `${type} content retrieved successfully`,
    data: content,
  });
});

/**
 * @desc    Create new content
 * @route   POST /api/content
 * @access  Private (Admin)
 */
const createContent = asyncHandler(async (req, res, next) => {
  const contentData = req.body;

  // Check if content ID already exists
  const existingContent = await Content.findOne({ id: contentData.id });
  if (existingContent) {
    return next(new ErrorResponse("Content with this ID already exists", 400));
  }

  const content = await Content.create(contentData);

  res.status(201).json({
    success: true,
    message: "Content created successfully",
    data: content,
  });
});

/**
 * @desc    Update content
 * @route   PUT /api/content/:id
 * @access  Private (Admin)
 */
const updateContent = asyncHandler(async (req, res, next) => {
  const { id } = req.params;
  const updateData = req.body;

  const content = await Content.findOneAndUpdate({ id }, updateData, {
    new: true,
    runValidators: true,
  });

  if (!content) {
    return next(new ErrorResponse("Content not found", 404));
  }

  res.status(200).json({
    success: true,
    message: "Content updated successfully",
    data: content,
  });
});

/**
 * @desc    Delete content (soft delete)
 * @route   DELETE /api/content/:id
 * @access  Private (Admin)
 */
const deleteContent = asyncHandler(async (req, res, next) => {
  const { id } = req.params;

  const content = await Content.findOneAndUpdate(
    { id },
    { isActive: false },
    { new: true }
  );

  if (!content) {
    return next(new ErrorResponse("Content not found", 404));
  }

  res.status(200).json({
    success: true,
    message: "Content deleted successfully",
  });
});

module.exports = {
  getAllContent,
  getContentById,
  getContentByModule,
  getContentByType,
  createContent,
  updateContent,
  deleteContent,
};
```

### Content Routes

```javascript
// server/src/routes/content.js
const express = require("express");
const {
  getAllContent,
  getContentById,
  getContentByModule,
  getContentByType,
  createContent,
  updateContent,
  deleteContent,
} = require("../controllers/contentController");
const { protect, authorize } = require("../middleware/auth");
const { validateRequest } = require("../middleware/validation");

const router = express.Router();

// Public routes (none - all content requires authentication)

// Protected routes
router.use(protect); // All routes below require authentication

router
  .route("/")
  .get(getAllContent)
  .post(authorize("admin"), validateRequest("createContent"), createContent);

router
  .route("/:id")
  .get(getContentById)
  .put(authorize("admin"), validateRequest("updateContent"), updateContent)
  .delete(authorize("admin"), deleteContent);

router.route("/module/:moduleId").get(getContentByModule);

router.route("/type/:type").get(getContentByType);

module.exports = router;

/**
 * @swagger
 * components:
 *   schemas:
 *     Content:
 *       type: object
 *       required:
 *         - id
 *         - moduleId
 *         - type
 *         - title
 *         - description
 *         - order
 *       properties:
 *         id:
 *           type: string
 *           description: Unique content identifier
 *           example: "basic-cybersec-intro-video"
 *         moduleId:
 *           type: string
 *           description: Reference to parent module
 *           example: "basic-cybersec"
 *         type:
 *           type: string
 *           enum: [video, lab, game]
 *           description: Type of content
 *           example: "video"
 *         title:
 *           type: string
 *           maxLength: 100
 *           description: Content title
 *           example: "Introduction to Cybersecurity"
 *         description:
 *           type: string
 *           maxLength: 500
 *           description: Content description
 *           example: "Learn the fundamentals of cybersecurity"
 *         url:
 *           type: string
 *           description: URL for video content (required for videos)
 *           example: "https://example.com/videos/intro"
 *         instructions:
 *           type: string
 *           maxLength: 2000
 *           description: Instructions for labs and games
 *           example: "Complete the following security assessment"
 *         order:
 *           type: number
 *           minimum: 1
 *           description: Order within module
 *           example: 1
 *         duration:
 *           type: number
 *           minimum: 1
 *           maximum: 300
 *           description: Duration in minutes
 *           example: 15
 *         metadata:
 *           type: object
 *           description: Additional content-specific data
 *           example: { "difficulty": "beginner", "tags": ["intro"] }
 *         isActive:
 *           type: boolean
 *           description: Whether content is active
 *           example: true
 *         createdAt:
 *           type: string
 *           format: date-time
 *           description: Creation timestamp
 *         updatedAt:
 *           type: string
 *           format: date-time
 *           description: Last update timestamp
 */

/**
 * @swagger
 * /api/content:
 *   get:
 *     summary: Get all content with optional filtering
 *     description: Retrieve content with filtering by type, module, and pagination
 *     tags: [Content]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: type
 *         schema:
 *           type: string
 *           enum: [video, lab, game]
 *         description: Filter by content type
 *       - in: query
 *         name: moduleId
 *         schema:
 *           type: string
 *         description: Filter by module ID
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           default: 10
 *         description: Number of items per page
 *       - in: query
 *         name: page
 *         schema:
 *           type: integer
 *           default: 1
 *         description: Page number
 *     responses:
 *       200:
 *         description: Content retrieved successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 message:
 *                   type: string
 *                   example: "Content retrieved successfully"
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/Content'
 *                 pagination:
 *                   type: object
 *                   properties:
 *                     page:
 *                       type: integer
 *                       example: 1
 *                     limit:
 *                       type: integer
 *                       example: 10
 *                     total:
 *                       type: integer
 *                       example: 25
 *                     pages:
 *                       type: integer
 *                       example: 3
 *       401:
 *         description: Unauthorized
 *   post:
 *     summary: Create new content
 *     description: Create new content item (admin only)
 *     tags: [Content]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             $ref: '#/components/schemas/Content'
 *     responses:
 *       201:
 *         description: Content created successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 message:
 *                   type: string
 *                   example: "Content created successfully"
 *                 data:
 *                   $ref: '#/components/schemas/Content'
 *       400:
 *         description: Validation error
 *       401:
 *         description: Unauthorized
 *       403:
 *         description: Forbidden (admin required)
 */

/**
 * @swagger
 * /api/content/{id}:
 *   get:
 *     summary: Get content by ID
 *     description: Retrieve specific content item by its ID
 *     tags: [Content]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *         description: Content ID
 *     responses:
 *       200:
 *         description: Content retrieved successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 message:
 *                   type: string
 *                   example: "Content retrieved successfully"
 *                 data:
 *                   $ref: '#/components/schemas/Content'
 *       404:
 *         description: Content not found
 *       401:
 *         description: Unauthorized
 *   put:
 *     summary: Update content
 *     description: Update existing content (admin only)
 *     tags: [Content]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *         description: Content ID
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             $ref: '#/components/schemas/Content'
 *     responses:
 *       200:
 *         description: Content updated successfully
 *       404:
 *         description: Content not found
 *       401:
 *         description: Unauthorized
 *       403:
 *         description: Forbidden (admin required)
 *   delete:
 *     summary: Delete content
 *     description: Soft delete content (admin only)
 *     tags: [Content]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *         description: Content ID
 *     responses:
 *       200:
 *         description: Content deleted successfully
 *       404:
 *         description: Content not found
 *       401:
 *         description: Unauthorized
 *       403:
 *         description: Forbidden (admin required)
 */

/**
 * @swagger
 * /api/content/module/{moduleId}:
 *   get:
 *     summary: Get content by module
 *     description: Retrieve all content for a specific module, ordered by sequence
 *     tags: [Content]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: moduleId
 *         required: true
 *         schema:
 *           type: string
 *         description: Module ID
 *     responses:
 *       200:
 *         description: Module content retrieved successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 message:
 *                   type: string
 *                   example: "Content for module basic-cybersec retrieved successfully"
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/Content'
 *       401:
 *         description: Unauthorized
 */

/**
 * @swagger
 * /api/content/type/{type}:
 *   get:
 *     summary: Get content by type
 *     description: Retrieve content filtered by type (video, lab, or game)
 *     tags: [Content]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: type
 *         required: true
 *         schema:
 *           type: string
 *           enum: [video, lab, game]
 *         description: Content type
 *       - in: query
 *         name: moduleId
 *         schema:
 *           type: string
 *         description: Optional module filter
 *     responses:
 *       200:
 *         description: Content by type retrieved successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 message:
 *                   type: string
 *                   example: "video content retrieved successfully"
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/Content'
 *       400:
 *         description: Invalid content type
 *       401:
 *         description: Unauthorized
 */
```

### Validation Middleware

```javascript
// server/src/middleware/validation/contentValidation.js
const { body, param } = require("express-validator");

const createContentValidation = [
  body("id")
    .notEmpty()
    .withMessage("Content ID is required")
    .isLength({ min: 3, max: 50 })
    .withMessage("Content ID must be between 3 and 50 characters")
    .matches(/^[a-z0-9-]+$/)
    .withMessage(
      "Content ID must contain only lowercase letters, numbers, and hyphens"
    ),

  body("moduleId")
    .notEmpty()
    .withMessage("Module ID is required")
    .isLength({ min: 3, max: 50 })
    .withMessage("Module ID must be between 3 and 50 characters"),

  body("type")
    .isIn(["video", "lab", "game"])
    .withMessage("Content type must be video, lab, or game"),

  body("title")
    .trim()
    .notEmpty()
    .withMessage("Title is required")
    .isLength({ max: 100 })
    .withMessage("Title cannot exceed 100 characters"),

  body("description")
    .trim()
    .notEmpty()
    .withMessage("Description is required")
    .isLength({ max: 500 })
    .withMessage("Description cannot exceed 500 characters"),

  body("url")
    .if(body("type").equals("video"))
    .notEmpty()
    .withMessage("URL is required for video content")
    .isURL()
    .withMessage("URL must be a valid URL"),

  body("instructions")
    .if(body("type").isIn(["lab", "game"]))
    .notEmpty()
    .withMessage("Instructions are required for lab and game content")
    .isLength({ max: 2000 })
    .withMessage("Instructions cannot exceed 2000 characters"),

  body("order")
    .isInt({ min: 1 })
    .withMessage("Order must be a positive integer"),

  body("duration")
    .optional()
    .isInt({ min: 1, max: 300 })
    .withMessage("Duration must be between 1 and 300 minutes"),
];

const updateContentValidation = [
  param("id").notEmpty().withMessage("Content ID is required"),

  // Same validations as create but all optional
  body("moduleId")
    .optional()
    .isLength({ min: 3, max: 50 })
    .withMessage("Module ID must be between 3 and 50 characters"),

  body("type")
    .optional()
    .isIn(["video", "lab", "game"])
    .withMessage("Content type must be video, lab, or game"),

  body("title")
    .optional()
    .trim()
    .isLength({ max: 100 })
    .withMessage("Title cannot exceed 100 characters"),

  body("description")
    .optional()
    .trim()
    .isLength({ max: 500 })
    .withMessage("Description cannot exceed 500 characters"),

  body("order")
    .optional()
    .isInt({ min: 1 })
    .withMessage("Order must be a positive integer"),

  body("duration")
    .optional()
    .isInt({ min: 1, max: 300 })
    .withMessage("Duration must be between 1 and 300 minutes"),
];

module.exports = {
  createContent: createContentValidation,
  updateContent: updateContentValidation,
};
```

## ðŸ§ª Testing Requirements

### Integration Tests

```javascript
// server/src/tests/routes/content.test.js
describe("Content API Endpoints", () => {
  let authToken;
  let adminToken;

  beforeEach(async () => {
    // Set up test data and authentication tokens
    await Content.deleteMany({});
    authToken = await getAuthToken("user");
    adminToken = await getAuthToken("admin");
  });

  describe("GET /api/content", () => {
    it("should get all content for authenticated user", async () => {
      await Content.create(testContentData);

      const response = await request(app)
        .get("/api/content")
        .set("Authorization", `Bearer ${authToken}`)
        .expect(200);

      expect(response.body.success).toBe(true);
      expect(response.body.data).toBeInstanceOf(Array);
    });

    it("should filter content by type", async () => {
      await Content.create([{ ...testVideoContent }, { ...testLabContent }]);

      const response = await request(app)
        .get("/api/content?type=video")
        .set("Authorization", `Bearer ${authToken}`)
        .expect(200);

      expect(response.body.data).toHaveLength(1);
      expect(response.body.data[0].type).toBe("video");
    });

    it("should return 401 without authentication", async () => {
      await request(app).get("/api/content").expect(401);
    });
  });

  describe("POST /api/content", () => {
    it("should create content with admin role", async () => {
      const response = await request(app)
        .post("/api/content")
        .set("Authorization", `Bearer ${adminToken}`)
        .send(testContentData)
        .expect(201);

      expect(response.body.success).toBe(true);
      expect(response.body.data.id).toBe(testContentData.id);
    });

    it("should return 403 for non-admin user", async () => {
      await request(app)
        .post("/api/content")
        .set("Authorization", `Bearer ${authToken}`)
        .send(testContentData)
        .expect(403);
    });

    it("should validate required fields", async () => {
      const invalidData = { ...testContentData };
      delete invalidData.title;

      await request(app)
        .post("/api/content")
        .set("Authorization", `Bearer ${adminToken}`)
        .send(invalidData)
        .expect(400);
    });
  });

  describe("GET /api/content/module/:moduleId", () => {
    it("should get content by module", async () => {
      await Content.create([
        { ...testVideoContent, moduleId: "test-module" },
        { ...testLabContent, moduleId: "test-module" },
        { ...testGameContent, moduleId: "other-module" },
      ]);

      const response = await request(app)
        .get("/api/content/module/test-module")
        .set("Authorization", `Bearer ${authToken}`)
        .expect(200);

      expect(response.body.data).toHaveLength(2);
      response.body.data.forEach((content) => {
        expect(content.moduleId).toBe("test-module");
      });
    });
  });
});
```

## ðŸŽ¯ Success Criteria

- [ ] All content API endpoints implemented and tested
- [ ] Comprehensive Swagger documentation added
- [ ] Request validation implemented for all inputs
- [ ] Authentication and authorization properly enforced
- [ ] Error handling for all edge cases
- [ ] Integration tests with 100% coverage
- [ ] Performance optimized with proper indexing
- [ ] Supports all content types (video, lab, game)
- [ ] Filtering and pagination implemented
- [ ] Admin-only routes properly protected

## ðŸ”— Dependencies

**Depends on**: CNT-001 (Unified Content Model)
**Blocks**: TRK-001 (UserEnrollment Model), FE-INT-001 (Frontend Integration)

## ðŸ“– Notes

- This unified API replaces the need for API-002, API-003, and API-004 tasks
- Single endpoint set handles all content types with proper type-based validation
- Swagger documentation is comprehensive and includes all schemas
- Admin-only routes for content management (create, update, delete)
- User routes for content consumption (read operations)
- Flexible metadata field allows for future content type extensions

**Benefits of Unified API**:

- Single API to maintain instead of 4+ separate APIs
- Consistent response format across all content types
- Easier frontend integration with one API client
- Simplified authentication and authorization logic
- Better performance with unified caching strategies
